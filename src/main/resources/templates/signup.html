<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Signup</title>
    <link th:rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" type="text/javascript" ></script>
    <script src="https://www.google.com/recaptcha/api.js" type="text/javascript" ></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
</head>

<body>
<script type="text/javascript">
    function validateAndGetCaptchaResponse() {
        const response = grecaptcha.getResponse();
        return response.length === 0 ? null : response;
    }

    $(document).ready(function () {
        $("#submit-button").click(function () {
            $("#captcha-error").html("");

            let captchaResponse = validateAndGetCaptchaResponse();
            if (captchaResponse) {
                console.log("Captcha code accepted.")
                let requestObj = {
                    'test': 'test'
                };

                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    headers: {
                        "captcha-response": captchaResponse
                    },
                    data: JSON.stringify(requestObj),
                    url: "http://localhost:8090/captcha",
                    success: function (data) {
                        alert(data.message);
                    }
                });
            } else {
                $("#captcha-error").html("You cannot leave the captcha code empty.");
            }
        });
    });
</script>

<div th:insert="fragments/header :: header"></div>
<div class="container w-50 p-3">
    <h1 class="display-5">Sign Up</h1>

    <form action="#" th:action="@{/signup}" th:object="${signupDTO}"  method="POST">

        <div id="success-msg" th:if="${signupSuccess}"
             class="alert alert-success">
            You successfully signed up! Please continue to the <a th:href="@{/login}">login</a> page.
        </div>
        <div id="error-msg" th:if="${signupError}" class="alert alert-danger">
            <span th:text="${signupError}"></span>
        </div>


        <div class="mb-3">
            <label for="inputFirstName">First Name</label>
            <input id="inputFirstName" type="text" th:field="*{firstName}" class="form-control">
            <div class="alert alert-warning" th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}"></div>
        </div>
        <div class="mb-3">
            <label for="inputLastName">Last Name</label>
            <input id="inputLastName" type="text" th:field="*{lastName}" class="form-control">
            <div class="alert alert-warning" th:if="${#fields.hasErrors('lastName')}" th:errors="*{lastName}"></div>
        </div>
        <div class="mb-3">
            <label for="inputEmail">Email</label>
            <input id="inputEmail" type="text" th:field="*{email}"
                   class="form-control">
            <div class="alert alert-warning" th:if="${#fields.hasErrors('email')}"
                 th:errors="*{email}"></div>
        </div>
        <div class="mb-3">
            <label for="inputUsername">Username</label>
            <input id="inputUsername" type="text" th:field="*{username}" class="form-control">
            <div class="alert alert-warning" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
        </div>

        <div class="mb-3">
            <label for="inputPassword">Password</label>
            <input id="inputPassword" type="password" th:field="*{password}" class="form-control">
            <div class="alert alert-warning" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
        </div>
        <div class="mb-3">
            <label for="inputPassword">Password Confirmation</label>
            <input id="inputPasswordTwo" type="password" name="confirmPassword" class="form-control">
        </div>

        <div class="mb-3">
            <label for="inputRole">Role</label>
            <select id="inputRole" name="role" class="form-select">
                <option value="ROLE_USER" selected>User</option>
                <option value="ROLE_ADMIN">Admin</option>
            </select>
        </div>

        <!-- Google captcha (I'm not robot checkbox) -->
        <!-- SITE_KEY - Represents the site_key generated by the Google reCaptcha service -->
        <div class="g-recaptcha" data-sitekey="6LdwE-8fAAAAAG8mkpjXka77Fz9qe8Tou0YMf7lR" id="recaptcha"></div>
        <span id="captcha-error" style="color:red"></span>

        <button id="submit-button" type="submit" class="btn btn-primary">Sign Up</button>
    </form>
</div>
</body>
</html>